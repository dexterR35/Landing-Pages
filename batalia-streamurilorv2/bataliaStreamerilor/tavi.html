<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
      integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <title>Document</title>
  </head>

  <body>
    <body>
      <div id="username">

      </div>
      <div id="optin">

      </div>
      <div id="voted">
        
      </div>
      <table id="rankingTable_streamers" border="1">
          <thead>
              <tr>
                <th>#</th>
                <th>Streamer</th>
                <th>Voturi</th>
                <th>Puncte</th>
                <th>Challenge</th>
              </tr>
          </thead>
          <tbody>
              <!-- Table rows will be populated here -->
          </tbody>
      </table>
      <table id="rankingTable_users" border="1">
        <thead>
            <tr>
                <th>#</th>
                <th>Username</th>
                <th>Points</th>
            </tr>
        </thead>
        <tbody>
            <!-- Table rows will be populated here -->
        </tbody>
    </table>  
    </body>
    <script>


    // function getCookie(name) {
    //   var nameEQ = name + "=";
    //   var ca = document.cookie.split(';');
    //   for (var i = 0; i < ca.length; i++) {
    //     var c = ca[i];
    //     while (c.charAt(0) == ' ') c = c.substring(1, c.length);
    //     if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
    //   }
    //   return null;
    // }

    // var userToCheck = getCookie("netbet_login");


userToCheck = "testcozminn" // DE LINKUIT AICI CHECKCOOKIE (VEZI MAI SUS)
userToVote = null;
pozitie = null;

// Define the API endpoint
const apiEndpoint_check_user = "https://casino-promo.netbet.ro/scripts/streamers/get.php?srv=check_user&user=" + userToCheck;
const apiEndpoint_clasament_streamers = "https://casino-promo.netbet.ro/scripts/streamers/get.php?srv=clasament_streamers";
const apiEndpoint_vote = "https://casino-promo.netbet.ro/scripts/streamers/get.php?srv=vote_user&user=" + userToCheck + "&vote=" + userToVote;
const apiEndpoint_optin_user = "https://casino-promo.netbet.ro/scripts/streamers/get.php?srv=optin_user&user=" + userToCheck;
const apiEndpoint_optout_user = "https://casino-promo.netbet.ro/scripts/streamers/get.php?srv=delete_user&user=" + userToCheck; 



// Make a GET request to the API for CHECK USER
fetch(apiEndpoint_check_user)
    .then(response => {
        // Check if the request was successful
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json(); // Parse the JSON from the response
    })
    .then(data => {
        // Initialize variables to hold optin, voted, and clasament data
        let optin = false;
        let voted = "Not available"; // Default value if "voted" is not in the response
        let clasament = null;

        // Iterate over the array and assign values to optin, voted, and clasament
        data.forEach(item => {
            if ('optin' in item) {
                optin = item.optin === "true"; // Convert string to boolean
            } else if ('voted' in item) {
                voted = item.voted; // Assign the string value to voted
            } else if ('clasament' in item) {
                clasament = item.clasament;
            }
        });

        // Check if optin and clasament have been assigned values
        if (optin !== null && clasament !== null) {
            // Log the optin and voted values
            console.log("Optin:", optin);
            console.log("Voted:", voted);

            document.querySelector("#username").innerHTML = userToCheck;
            
            if (optin == true) {
                document.querySelector("#optin").innerHTML = `Userul este optin? ` + optin + ` <button onclick="">opt out</button>`;
            } else {
                document.querySelector("#optin").innerHTML = `Userul este optin? ` + optin + ` <button onclick="">opt in</button>`;
            }

            if (voted == "Not available") {
                document.querySelector("#voted").innerHTML = 'Userul nu e Opt In deci nu poate vota';
            } else {
                document.querySelector("#voted").innerHTML = 'Userul a votat? ' + voted + ` <button onclick="">Voteaza</button>`;
            }

        // Build User Table
        const tableBody_users = document.querySelector("#rankingTable_users tbody");
        
        console.log("Clasamentul are : ", clasament.length, " entries")

        clasament.forEach(item => {
                if (item.username === userToCheck) {
                    pozitie = item.ranking;
                    console.log ("am gasit userul pe pozitia ", pozitie)
                }
            })
        

            if (pozitie <= 10) {
                console.log ("userul e top 10"); 
                clasament.slice(0, 10).forEach(item => {
                    tableDataUser.append(createTableUsers(item));
                });

            } else if (pozitie >10 && pozitie<=200) {
                console.log ("userul e in top 200");
                if (clasament.length == 17) {
                    console.log ("userul nu e intre ultimii 3");

                    clasament.slice(0, 3).forEach(item => {
                        tableDataUser.append(createTableUsers(item));
                    
                    });

                    clasament.slice(10, 17).forEach(item => {
                        tableDataUser.append(createTableUsers(item));
                    
                    });


                } else {
                    console.log ("userul e intre ultimii 3");

                    clasament.slice(0, 6).forEach(item => {
                        tableDataUser.append(createTableUsers(item));
                    
                    });

                    clasament.slice(clasament.length-4, clasament.length).forEach(item => {
                        tableDataUser.append(createTableUsers(item));
                    });                    

                }
            } else if (pozitie>200) {
                console.log ("userul e mai jos de 200")
                if (clasament.length == 20) {
                    console.log ("userul nu e intre ultimii 3");
                    clasament.slice(0, 3).forEach(item => {
                        tableDataUser.append(createTableUsers(item));
                        });
                        clasament.slice(10, 13).forEach(item => {
                            tableDataUser.append(createTableUsers(item));
                        });
    
                        clasament.slice(14, 18).forEach(item => {
                            tableDataUser.append(createTableUsers(item));
                        
                        });                    
                } else {
                    console.log ("userul e intre ultimii 3");

                    clasament.slice(0, 3).forEach(item => {
                        tableDataUser.append(createTableUsers(item));
                    
                    });

                    clasament.slice(10, 13).forEach(item => {
                        tableDataUser.append(createTableUsers(item));
                        
                    });                    

                    clasament.slice(clasament.length-4, clasament.length).forEach(item => {
            
                        tableDataUser.append(createTableUsers(item));
                    });                          
                }
            }


        } else {
            console.error("Invalid response structure:", data);
        }
        
    
    })
    .catch(error => {
        // Log any errors that occurred during the fetch
        console.error("Fetch error:", error);
    });


// Make a GET request to the API for CLASAMENT STREAMERS
fetch(apiEndpoint_clasament_streamers)
    .then(response => {
        // Check if the request was successful
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json(); // Parse the JSON from the response
    })
    .then(data => {
        // Initialize variables
        let ranking = null;
        let username = null; 
        let points = null;
        let status = null;
        let votes = null;
        const tableBody_streamers = document.querySelector("#rankingTable_streamers tbody");
        
        data.forEach(item => {
          ranking = item.ranking;
          username = item.username;
          points = item.points;
          status = item.status;
          votes = item.votes;
          
          const row = document.createElement("tr");
          // Create cells for ranking, username, and points and append them to the row
          row.innerHTML = `
          <td>${item.ranking}</td>
          <td>${item.username}<button onclick="">Vote for challenge</button></td>
          <td>${item.votes}</td>
          <td>${item.points}</td>
          <td>${item.status}</td>
          `;  
          tableBody_streamers.appendChild(row);
        });

    

    })
    .catch(error => {
        // Log any errors that occurred during the fetch
        console.error("Fetch error:", error);
    });

    

    async function optOut() {
        console.log("optout")
        await fetch(apiEndpoint_optout_user)
            .then(response => {
                // Check if the request was successful
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json(); // Parse the JSON from the response
            })
            .catch(error => {
                // Log any errors that occurred during the fetch
                console.error("Fetch error:", error);
            });
    }

    async function optIn() {
        console.log("optin")
        await fetch(apiEndpoint_optin_user)
            .then(response => {
                // Check if the request was successful
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json(); // Parse the JSON from the response
            })
            .catch(error => {
                // Log any errors that occurred during the fetch
                console.error("Fetch error:", error);
            });
    }    

    async function voteStreamer(user){
        userToVote = user;
        console.log ("Votam pe " + userToVote)

        await fetch(apiEndpoint_vote)
            .then(response => {
                // Check if the request was successful
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json(); // Parse the JSON from the response
            })
            .catch(error => {
                // Log any errors that occurred during the fetch
                console.error("Fetch error:", error);
            });
    }






    //   // populam tabelul cu streamerii
    //   const tableBody_users = document.querySelector("#rankingTable_users tbody")

    //   if (clasament !== null) {
    //     // Limit the number of rows to 10
    //     clasament.slice(0, 10).forEach(item => {
    //     // Create a new table row
    //     const row = document.createElement("tr");
  
    //     // Create cells for ranking, username, and points and append them to the row
    //     row.innerHTML = `
    //       <td>${item.ranking}</td>
    //       <td>${item.username}</td>
    //       <td>${item.points}</td>
    //   `;
  
    //     // Append the row to the table body
    //     tableBody_users.appendChild(row);
    //       });

    //       clasament.slice(10, 17).forEach(item => {
    //     // Create a new table row
    //     const row = document.createElement("tr");
  
    //     // Create cells for ranking, username, and points and append them to the row
    //     row.innerHTML = `
    //       <td>${item.ranking}</td>
    //       <td>${item.username}</td>
    //       <td>${item.points}</td>
    //   `;
  
    //     // Append the row to the table body
    //     tableBody_users.appendChild(row);
    //       });          

    //   } else {
    //     console.error("Invalid response structure:", data);
    //   }    
    
    </script>
  </body>
</html>