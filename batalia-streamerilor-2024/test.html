<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Opt-In/Opt-Out</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        #user-info {
            margin: 20px;
        }
        .loading {
            display: none;
            font-style: italic;
            color: gray;
        }
    </style>
</head>
<body>
    <div id="user-info">
        <p class="loading">Loading player data...</p>
        <!-- Player info and opt-in/opt-out button will be displayed here -->
    </div>
    <script>
        const token = '2f97bb641f2096c1e98a723c249a6ece';
        const url = 'https://qaadmin.livepartners.com/api/streaming/';
        const username = 'testcozminn'; // Specify the username you want to check

        // Function to check if a player exists in the table
        function checkIfPlayerExists(username) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: url + 'check/' + username,
                    type: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    success: function(response) {
                        console.log('Check Player Exists Response:', response);
                        if (typeof response === 'boolean') {
                            resolve(response);
                        } else if (response && response.exists !== undefined) {
                            resolve(response.exists);
                        } else {
                            resolve(false);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error checking if player exists:', error);
                        reject(error);
                    }
                });
            });
        }

        // Function to add a new player to the table
        function optInPlayer(username) {
            $('.loading').show();
            $.ajax({
                url: url + 'optin/' + username,
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                success: function(response) {
                    console.log('Opt-In Response:', response);
                    $('#message').text(`Player ${username} has been successfully added to the table.`);
                    updateUI(true); // Update UI to reflect opt-out state
                },
                error: function(xhr, status, error) {
                    if (xhr.status === 409) {
                        $('#message').text(`Player ${username} already exists in the table. Cannot opt-in again.`);
                    } else {
                        console.error('Error opting in player:', error);
                        $('#message').text('Error adding player. Please try again later.');
                    }
                },
                complete: function() {
                    $('.loading').hide();
                }
            });
        }

        // Function to remove a player from the table
        function optOutPlayer(username) {
            $('.loading').show();
            $.ajax({
                url: url + 'optout/' + username,
                type: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                success: function(response) {
                    console.log('Opt-Out Response:', response);
                    $('#message').text(`Player ${username} has been successfully removed from the table.`);
                    updateUI(false); // Update UI to reflect opt-in state
                },
                error: function(xhr, status, error) {
                    console.error('Error opting out player:', error);
                    $('#message').text('Error removing player. Please try again later.');
                },
                complete: function() {
                    $('.loading').hide();
                }
            });
        }

        // Function to update the UI based on player state
        function updateUI(playerExists) {
            if (playerExists) {
                // Player exists, show opt-out button
                $('#user-info').html(`
                    <p>Player ${username} already exists in the table.</p>
                    <button id="optout-btn">Opt-Out Player</button>
                    <p id="message"></p>
                `);
                $('#optout-btn').click(function() {
                    optOutPlayer(username);
                });
            } else {
                // Player does not exist, show opt-in button
                $('#user-info').html(`
                    <p>Player ${username} does not exist in the table.</p>
                    <button id="optin-btn">Opt-In Player</button>
                    <p id="message"></p>
                `);
                $('#optin-btn').click(function() {
                    optInPlayer(username);
                });
            }
        }

        // Initial check and UI setup
        $(document).ready(function() {
            $('.loading').show();
            checkIfPlayerExists(username).then(exists => {
                updateUI(exists);
            }).catch(error => {
                console.error('An error occurred while checking player existence:', error);
                $('#user-info').html('<p>Failed to check player existence. Please try again later.</p>');
            }).finally(() => {
                $('.loading').hide();
            });
        });
    </script>
</body>
</html>
